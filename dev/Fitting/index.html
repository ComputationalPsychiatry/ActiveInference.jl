<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Model Fitting · ActiveInference.jl</title><meta name="title" content="Model Fitting · ActiveInference.jl"/><meta property="og:title" content="Model Fitting · ActiveInference.jl"/><meta property="twitter:title" content="Model Fitting · ActiveInference.jl"/><meta name="description" content="Documentation for ActiveInference.jl."/><meta property="og:description" content="Documentation for ActiveInference.jl."/><meta property="twitter:description" content="Documentation for ActiveInference.jl."/><meta property="og:url" content="https://ilabcode.github.io/ActiveInference.jl/Fitting/"/><meta property="twitter:url" content="https://ilabcode.github.io/ActiveInference.jl/Fitting/"/><link rel="canonical" href="https://ilabcode.github.io/ActiveInference.jl/Fitting/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../Introduction/">ActiveInference.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><span class="tocitem">General Introduction</span><ul><li><a class="tocitem" href="../Introduction/">Introduction</a></li><li><a class="tocitem" href="../GenerativeModelCreation/">Creation of the Generative Model</a></li><li><a class="tocitem" href="../AgentCreation/">Creating the Agent</a></li><li><a class="tocitem" href="../Simulation/">Simulation</a></li><li class="is-active"><a class="tocitem" href>Model Fitting</a><ul class="internal"><li><a class="tocitem" href="#Quick-Start"><span>Quick Start</span></a></li></ul></li><li><a class="tocitem" href="../SimulationActionModels/">Simulation with ActionModels.jl</a></li></ul></li><li><span class="tocitem">Usage Examples</span><ul><li><a class="tocitem" href="../TMazeSimulationExample/">T-Maze Simulation</a></li></ul></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../GenerativeModelTheory/">POMDP Theory</a></li></ul></li><li><a class="tocitem" href="../">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">General Introduction</a></li><li class="is-active"><a href>Model Fitting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Model Fitting</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ilabcode/ActiveInference.jl/blob/master/docs/julia_files/Fitting.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Model-Fitting"><a class="docs-heading-anchor" href="#Model-Fitting">Model Fitting</a><a id="Model-Fitting-1"></a><a class="docs-heading-anchor-permalink" href="#Model-Fitting" title="Permalink"></a></h1><p>In many cases, we want to be able to draw conclusions about specific observed phenomena, such as behavioural differences between distinct populations. A conventional approach in this context is model fitting, which involves estimating the parameter values of a model (e.g., prior beliefs) that are most likely given the observed behavior of a participant. This approach is often used in fields such as computational psychiatry or mathematical psychology  to develop more precise models and theories of mental processes, to find mechanistic differences between clinical populations, or to investigate the relationship between computational constructs such as Bayesian beliefs and neuronal dynamics.</p><h2 id="Quick-Start"><a class="docs-heading-anchor" href="#Quick-Start">Quick Start</a><a id="Quick-Start-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-Start" title="Permalink"></a></h2><h4 id="Model-Fitting-with-ActionModels.jl"><a class="docs-heading-anchor" href="#Model-Fitting-with-ActionModels.jl">Model Fitting with ActionModels.jl</a><a id="Model-Fitting-with-ActionModels.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Model-Fitting-with-ActionModels.jl" title="Permalink"></a></h4><p>Model fitting in &#39;<strong>ActiveInference</strong>&#39; is mediated through &#39;<strong>ActionModels</strong>&#39;, which is our sister package for implementing and fitting various behavioural models to data. The core of &#39;<strong>ActionModels</strong>&#39; is the action model function, which takes a single observation, runs the inference scheme (updating the agent&#39;s beliefs), and calculates the probability distribution over actions from which the agent samples its actions. <em>(Check out the <a href="https://ilabcode.github.io/ActionModels.jl/dev/markdowns/Introduction/">ActionModels documentation</a> for more details)</em></p><p>To demonstrate this, let&#39;s define a very simple generative model with a single state factor and two possible actions, and then initialize our active inference object:</p><pre><code class="language-julia hljs"># Define the number of states, observations, and controls
n_states = [4]
n_observations = [4]
n_controls = [2]

# Define the policy length
policy_length = 1

# Use the create_matrix_templates function to create uniform A and B matrices.
A, B = create_matrix_templates(n_states, n_observations, n_controls, policy_length)

# Initialize an active inference object with the created matrices
aif = init_aif(A, B)</code></pre><p>We can now use the <code>action_pomdp!</code> function (which serves as our active inference &quot;action model&quot;) to calculate the probability distribution over actions for a single observation:</p><pre><code class="language-julia hljs"># Define observation
observation = [1]

# Calculate action probabilities
action_distribution = action_pomdp!(aif, observation)</code></pre><h4 id="Agent-in-ActionModels.jl"><a class="docs-heading-anchor" href="#Agent-in-ActionModels.jl">Agent in ActionModels.jl</a><a id="Agent-in-ActionModels.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Agent-in-ActionModels.jl" title="Permalink"></a></h4><p>Another key component of &#39;<strong>ActionModels</strong>&#39; is an <code>Agent</code>, which wraps the action model and active inference object in a more abstract structure. The <code>Agent</code> is initialized using a <code>substruct</code> to include our active inference object, and the action model is our <code>action_pomdp!</code> function.</p><p>Let&#39;s first install &#39;<strong>ActionModels</strong>&#39; from the official Julia registry and import it:</p><pre><code class="language-julia hljs">Pkg.add(&quot;ActionModels&quot;)
using ActionModels</code></pre><p>We can now create an <code>Agent</code> with the <code>action_pomdp!</code> function and the active inference object:</p><pre><code class="language-julia hljs"># Initialize agent with active inference object as substruct
agent = init_agent(
    action_pomdp!,  # The active inference action model
    substruct = aif # The active inference object
)</code></pre><p>We use an initialized <code>Agent</code> primarily for fitting; however, it can also be used with a set of convenience functions to run simulations, which are described in <a href="../SimulationActionModels/">Simulation with ActionModels</a>.</p><h4 id="Fitting-a-Single-Subject-Model"><a class="docs-heading-anchor" href="#Fitting-a-Single-Subject-Model">Fitting a Single Subject Model</a><a id="Fitting-a-Single-Subject-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-a-Single-Subject-Model" title="Permalink"></a></h4><p>We have our <code>Agent</code> object defined as above. Next, we need to specify priors for the parameters we want to estimate.</p><p>For example, let&#39;s estimate the action precision parameter <code>α</code> and use a Gamma distribution as its prior.</p><pre><code class="language-julia hljs"># Import the Distributions package
using Distributions

# Define the prior distribution for the alpha parameters inside a dictionary
priors = Dict(&quot;alpha&quot; =&gt; Gamma(1, 1))</code></pre><p>We can now use the <code>create_model</code> function to instantiate a probabilistic model object with data. This function takes the <code>Agent</code> object, the priors, and a set of observations and actions as arguments.</p><p>First, let&#39;s define some observations and actions as vectors:</p><pre><code class="language-julia hljs"># Define observations and actions
observations = [1, 1, 2, 3, 1, 4, 2, 1]
actions = [2, 1, 2, 2, 2, 1, 2, 2]</code></pre><p>Now we can instantiate the probabilistic model object:</p><pre><code class="language-julia hljs"># Create the model object
single_subject_model = create_model(agent, priors, observations, actions)</code></pre><p>The <code>single_subject_model</code> can be used as a standard Turing object. Performing inference on this model is as simple as:</p><pre><code class="language-julia hljs">results = fit_model(single_subject_model)</code></pre><h4 id="Fitting-a-Model-with-Multiple-Subjects"><a class="docs-heading-anchor" href="#Fitting-a-Model-with-Multiple-Subjects">Fitting a Model with Multiple Subjects</a><a id="Fitting-a-Model-with-Multiple-Subjects-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-a-Model-with-Multiple-Subjects" title="Permalink"></a></h4><p>Often, we have data from multiple subjects that we would like to fit simultaneously. The good news is that this can be done by instantiating our probabilisitc model on an entire dataset containing data from multiple subjects.</p><p>Let&#39;s define some dataset with observations and actions for three subjects:</p><pre><code class="language-julia hljs"># Import the DataFrames package
using DataFrames

# Create a DataFrame
data = DataFrame(
   subjectID = [1, 1, 1, 2, 2, 2, 3, 3, 3], # Subject IDs
   observations = [1, 1, 2, 3, 1, 4, 2, 1, 3], # Observations
   actions = [2, 1, 2, 2, 2, 1, 2, 2, 1] # Actions
)</code></pre><div><div style = "float: left;"><span>9×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">subjectID</th><th style = "text-align: left;">observations</th><th style = "text-align: left;">actions</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "Int64" style = "text-align: left;">Int64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: right;">2</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: right;">1</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">1</td><td style = "text-align: right;">2</td><td style = "text-align: right;">2</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">2</td><td style = "text-align: right;">3</td><td style = "text-align: right;">2</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">2</td><td style = "text-align: right;">1</td><td style = "text-align: right;">2</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: right;">2</td><td style = "text-align: right;">4</td><td style = "text-align: right;">1</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: right;">3</td><td style = "text-align: right;">2</td><td style = "text-align: right;">2</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: right;">3</td><td style = "text-align: right;">1</td><td style = "text-align: right;">2</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: right;">3</td><td style = "text-align: right;">3</td><td style = "text-align: right;">1</td></tr></tbody></table></div><p>To instantiate the probabilistic model on our dataset, we pass the <code>data</code> DataFrame to the <code>create_model</code> function along with the names of the columns that contain the subject identifiers, observations, and actions:</p><pre><code class="language-julia hljs"># Create the model object
multi_subject_model = create_model(
    agent,
    priors,
    data; # Dataframe
    grouping_cols = [:subjectID], # Column with subject IDs
    input_cols = [&quot;observations&quot;], # Column with observations
    action_cols = [&quot;actions&quot;] # Column with actions
)</code></pre><p>To fit the model, we use the <code>fit_model</code> function as before:</p><pre><code class="language-julia hljs">results = fit_model(multi_subject_model)</code></pre><pre><code class="nohighlight hljs">┌ Info: Found initial step size
└   ϵ = 1.6
</code></pre><h4 id="Customizing-the-Fitting-Procedure"><a class="docs-heading-anchor" href="#Customizing-the-Fitting-Procedure">Customizing the Fitting Procedure</a><a id="Customizing-the-Fitting-Procedure-1"></a><a class="docs-heading-anchor-permalink" href="#Customizing-the-Fitting-Procedure" title="Permalink"></a></h4><p>The <code>fit_model</code> function has several optional arguments that allow us to customize the fitting procedure. For example, you can specify the number of iterations, the number of chains, the sampling algorithm, or to parallelize over chains:</p><pre><code class="language-julia hljs">results = fit_model(
    multi_subject_model, # The model object
    parallelization = MCMCDistributed(), # Run chains in parallel
    sampler = NUTS(;adtype=AutoReverseDiff(compile=true)), # Specify the type of sampler
    n_itererations = 1000, # Number of iterations,
    n_chains = 4, # Number of chains
)</code></pre><p>&#39;<strong>Turing</strong>&#39; allows us to run distributed <code>MCMCDistributed()</code> or threaded <code>MCMCThreads()</code> parallel sampling. The default is to run chains serially <code>MCMCSerial()</code>. For information on the available samplers see the <a href="https://turing.ml/dev/docs/using-turing/samplers/">Turing documentation</a>.</p><h4 id="Results"><a class="docs-heading-anchor" href="#Results">Results</a><a id="Results-1"></a><a class="docs-heading-anchor-permalink" href="#Results" title="Permalink"></a></h4><p>The output of the <code>fit_model</code> function is an object that contains the standard &#39;<strong>Turing</strong>&#39; chains which we can use to extract the summary statistics of the posterior distribution.</p><p>Let&#39;s extract the chains from the results object:</p><pre><code class="language-julia hljs">chains = results.chains</code></pre><pre><code class="nohighlight hljs">Chains MCMC chain (1000×15×1 Array{Float64, 3}):

Iterations        = 501:1:1500
Number of chains  = 1
Samples per chain = 1000
Wall duration     = 10.4 seconds
Compute duration  = 10.4 seconds
parameters        = parameters[1, 1], parameters[1, 2], parameters[1, 3]
internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size

Summary Statistics
        parameters      mean       std      mcse   ess_bulk   ess_tail      rhat   ess_per_sec
            Symbol   Float64   Float64   Float64    Float64    Float64   Float64       Float64

  parameters[1, 1]    1.1032    1.3316    0.0800   554.4423   486.5081    1.0015       53.2913
  parameters[1, 2]    0.9569    0.9962    0.0529   213.9131   195.5007    1.0098       20.5607
  parameters[1, 3]    1.0434    0.9955    0.0362   533.5792   257.0896    0.9995       51.2860

Quantiles
        parameters      2.5%     25.0%     50.0%     75.0%     97.5%
            Symbol   Float64   Float64   Float64   Float64   Float64

  parameters[1, 1]    0.0251    0.2906    0.7353    1.4625    3.9916
  parameters[1, 2]    0.0262    0.2121    0.6178    1.3974    3.5309
  parameters[1, 3]    0.0442    0.2970    0.7556    1.4411    3.7771
</code></pre><p>Note that the parameter names in the chains are somewhat cryptic. We can use the <code>rename_chains</code> function to rename them to something more understandable:</p><pre><code class="language-julia hljs">renamed_chains = rename_chains(chains, multi_subject_model)</code></pre><pre><code class="nohighlight hljs">Chains MCMC chain (1000×15×1 Array{Float64, 3}):

Iterations        = 501:1:1500
Number of chains  = 1
Samples per chain = 1000
Wall duration     = 10.4 seconds
Compute duration  = 10.4 seconds
parameters        = subjectID:1.alpha, subjectID:2.alpha, subjectID:3.alpha
internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size

Summary Statistics
         parameters      mean       std      mcse   ess_bulk   ess_tail      rhat   ess_per_sec
             Symbol   Float64   Float64   Float64    Float64    Float64   Float64       Float64

  subjectID:1.alpha    1.1032    1.3316    0.0800   554.4423   486.5081    1.0015       53.2913
  subjectID:2.alpha    0.9569    0.9962    0.0529   213.9131   195.5007    1.0098       20.5607
  subjectID:3.alpha    1.0434    0.9955    0.0362   533.5792   257.0896    0.9995       51.2860

Quantiles
         parameters      2.5%     25.0%     50.0%     75.0%     97.5%
             Symbol   Float64   Float64   Float64   Float64   Float64

  subjectID:1.alpha    0.0251    0.2906    0.7353    1.4625    3.9916
  subjectID:2.alpha    0.0262    0.2121    0.6178    1.3974    3.5309
  subjectID:3.alpha    0.0442    0.2970    0.7556    1.4411    3.7771
</code></pre><p>That looks better! We can now use the &#39;<strong>StatsPlots</strong>&#39; package to plot the chain traces and density plots of the posterior distributions for all subjects:</p><pre><code class="language-julia hljs">using StatsPlots # Load the StatsPlots package

plot(renamed_chains)</code></pre><p><img src="../assets/chain_traces.png" alt="image2"/></p><p>We can also visualize the posterior distributions against the priors. This can be done by first taking samples from the prior:</p><pre><code class="language-julia hljs"># Sample from the prior
prior_chains = sample(multi_subject_model, Prior(), 1000)
# Rename parameters in the prior chains
renamed_prior_chains = rename_chains(prior_chains, multi_subject_model)</code></pre><p>To plot the posterior distributions against the priors, we use the <code>plot_parameters</code> function:</p><pre><code class="language-julia hljs">plot_parameters(renamed_prior_chains, renamed_chains)</code></pre><p><img src="../assets/posteriors.png" alt="image3"/></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Simulation/">« Simulation</a><a class="docs-footer-nextpage" href="../SimulationActionModels/">Simulation with ActionModels.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Monday 20 January 2025 12:17">Monday 20 January 2025</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
